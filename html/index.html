<html>
<head>
    <title>websockets client</title>
    <style>
			html, body {
			  background:#f0f0f0;
			  height: 100%;
				font-family:tahoma;
			}
			
			.heading {text-align:center;}
		  .rawval {width:40px; font-size:12px; border: 0px; background:#b0b0b0; }
		  .minval {width:40px; font-size:12px; border: 0px; color:#808080; background:none;}
		  .maxval {width:40px; font-size:12px; border: 0px; color:#808080; background:none;}

			.bga { background:#ffd0d0; }
			.bgm { background:#d0ffd0; }
			.bgg { background:#d0d0ff; }
		</style>
</head>
<body>

<br>
On/Off:
<input type="button" value="#o0" onClick="WSocket.Send(this.value)">
<input type="button" value="#o1" onClick="WSocket.Send(this.value)">
<input type="button" value="#f" onClick="WSocket.Send(this.value)">
Text modes:
<input type="button" value="#osrt" onClick="WSocket.Send(this.value)">
<input type="button" value="#osct" onClick="WSocket.Send(this.value)">
<input type="button" value="#osbt" onClick="WSocket.Send(this.value)">
<input type="button" value="#ot" onClick="WSocket.Send(this.value)">
Calib:
<input type="button" value="#oc" onClick="WSocket.Send(this.value)">
<input type="button" value="#on" onClick="WSocket.Send(this.value)">
Errors:
<input type="button" value="#oe0" onClick="WSocket.Send(this.value)">
<input type="button" value="#oe1" onClick="WSocket.Send(this.value)">

<!--
<table>
<tr><td></td><td class="heading">X</td><td class="heading">Y</td><td class="heading">Z</td><td></td></tr>
<tr><td>Acc</td>                                                                           
  <td><input class="minval" type="text" id="axmin"><input class="rawval" type="text" id="ax"><input class="maxval" type="text" id="axmax"></td>
  <td><input class="minval" type="text" id="aymin"><input class="rawval" type="text" id="ay"><input class="maxval" type="text" id="aymax"></td>
  <td><input class="minval" type="text" id="azmin"><input class="rawval" type="text" id="az"><input class="maxval" type="text" id="azmax"></td>
  <td><input class="resetrange" type="button" id="reseta" value="Reset"></td>
</tr>
<tr><td>Mag</td>                                                                           
  <td><input class="minval" type="text" id="mxmin"><input class="rawval" type="text" id="mx"><input class="maxval" type="text" id="mxmax"></td>
	<td><input class="minval" type="text" id="mymin"><input class="rawval" type="text" id="my"><input class="maxval" type="text" id="mymax"></td>
  <td><input class="minval" type="text" id="mzmin"><input class="rawval" type="text" id="mz"><input class="maxval" type="text" id="mzmax"></td>
  <td><input class="resetrange" type="button" id="resetm" value="Reset"></td>
</tr>
<tr><td>Gyro</td>
  <td><input class="minval" type="text" id="gxmin"><input class="rawval" type="text" id="gx"><input class="maxval" type="text" id="gxmax"></td>
  <td><input class="minval" type="text" id="gymin"><input class="rawval" type="text" id="gy"><input class="maxval" type="text" id="gymax"></td>
  <td><input class="minval" type="text" id="gzmin"><input class="rawval" type="text" id="gz"><input class="maxval" type="text" id="gzmax"></td>
  <td><input class="resetrange" type="button" id="resetg" value="Reset"></td>
</tr>
</table>
-->

<table>
<tr><td></td><td class="heading">Acc</td><td class="heading">Mag</td><td class="heading">Gyro</td><td></td></tr>
<tr><td>X</td>                                                                           
  <td class="bga"><input class="minval" type="text" id="axmin"><input class="rawval" type="text" id="ax"><input class="maxval" type="text" id="axmax"></td>
  <td class="bgm"><input class="minval" type="text" id="mxmin"><input class="rawval" type="text" id="mx"><input class="maxval" type="text" id="mxmax"></td>
  <td class="bgg"><input class="minval" type="text" id="gxmin"><input class="rawval" type="text" id="gx"><input class="maxval" type="text" id="gxmax"></td>
</tr>
<tr><td>Y</td>                                                                           
  <td class="bga"><input class="minval" type="text" id="aymin"><input class="rawval" type="text" id="ay"><input class="maxval" type="text" id="aymax"></td>
	<td class="bgm"><input class="minval" type="text" id="mymin"><input class="rawval" type="text" id="my"><input class="maxval" type="text" id="mymax"></td>
  <td class="bgg"><input class="minval" type="text" id="gymin"><input class="rawval" type="text" id="gy"><input class="maxval" type="text" id="gymax"></td>
</tr>
<tr><td>Z</td>
  <td class="bga"><input class="minval" type="text" id="azmin"><input class="rawval" type="text" id="az"><input class="maxval" type="text" id="azmax"></td>
  <td class="bgm"><input class="minval" type="text" id="mzmin"><input class="rawval" type="text" id="mz"><input class="maxval" type="text" id="mzmax"></td>
  <td class="bgg"><input class="minval" type="text" id="gzmin"><input class="rawval" type="text" id="gz"><input class="maxval" type="text" id="gzmax"></td>
</tr>
<tr>
  <td></td>
  <td class="bga"><input class="resetrange" type="button" id="reseta" value="Reset"></td>
  <td class="bgm"><input class="resetrange" type="button" id="resetm" value="Reset"></td>
  <td class="bgg"><input class="resetrange" type="button" id="resetg" value="Reset"></td>
</tr>
</table>

<canvas id="canvas" width="400" height="400" style="border:solid 1px #000000;"></canvas>
<canvas id="3d" width="400" height="400" style="border:solid 1px #000000;"></canvas>
<pre id="txt">Result...</div>

    <script type="text/javascript">
				String.prototype.trim=function(){return this.replace(/^\s\s*/, '').replace(/\s\s*$/, '');};

				var SocketClass = function()
        {
					// private
					var ws = null;
					var arrListeners = new Array();
					var _this = this;
					var buffer = "";

					var url = "ws://127.0.0.1:38950/resourcePath";

					// public
					this.Send = function( msg ) 
					{
						ws.send( msg );
					}
					this.Receive = function ( msg )
					{
						buffer += msg;
						var e = buffer.indexOf("\n");
						while ( (e= buffer.indexOf("\n")) >= 0 )
						{
							var line = buffer.substr(0, e);
							buffer = buffer.substr(e+1);
							OnLine(line);
						}	
					}
					this.Connect = function()
					{
            document.title = "Connecting...";
	          ws = new WebSocket(url);
            ws.onmessage = this.onMessage;
            ws.onopen = this.onOpen;
            ws.onclose = this.onClose;
            ws.onerror = this.onError;
          }

					// private
					this.onMessage = function(evt)
					{
            if (typeof evt !== "undefined" && typeof evt.data == "string") {
								_this.Receive( evt.data.toString() );
            }
					}

					this.onOpen = function(evt)
					{
						document.title = "Online";
					}

					this.onClose = function(evt)
					{
						document.title = "Offline";
					}
					this.onEror = function(evt)
					{
						document.title = "Error";
						alert(evt);
					}
				};

				var WSocket = new SocketClass();

        window.onload = function () {
          setTimeout( "WSocket.Connect();", 200 );
          setTimeout( "WSocket.Send('#osrt');", 500 ); // switch to text mode, raw values
 					setInterval("update()",50);
					init3d();
        };


last = [];
dataG = {x:{minimum:0, maximum:0, raw:0}, y:{minimum:0, maximum:0, raw:0}, z:{minimum:0, maximum:0, raw:0}};
dataM = {x:{minimum:0, maximum:0, raw:0}, y:{minimum:0, maximum:0, raw:0}, z:{minimum:0, maximum:0, raw:0}};
dataA = {x:{minimum:0, maximum:0, raw:0}, y:{minimum:0, maximum:0, raw:0}, z:{minimum:0, maximum:0, raw:0}};
dataC = []; // corrected yaw pitch roll

function usevalues(obj, arr)
{
	x = parseInt(arr[0]);
	if ( obj.x.minimum == obj.x.maximum && obj.x.maximum == 0)
		obj.x.minimum = obj.x.maximum = x;
	if ( x < obj.x.minimum )
		obj.x.minimum = x;
	if ( x > obj.x.maximum )
		obj.x.maximum = x;
	obj.x.raw = x;

	y = parseInt(arr[1]);
	if ( obj.y.minimum == obj.y.maximum && obj.y.maximum == 0 )
		obj.y.minimum = obj.y.maximum = y;
	if ( y < obj.y.minimum )
		obj.y.minimum = y;
	if ( y > obj.y.maximum )
		obj.y.maximum = y;
	obj.y.raw = y;

	z = parseInt(arr[2]);
	if ( obj.z.minimum == obj.z.maximum && obj.z.maximum == 0 )
		obj.z.minimum = obj.z.maximum = z;
	if ( y < obj.y.minimum )
		obj.y.minimum = y;
	if ( z > obj.z.maximum )
		obj.z.maximum = z;
	obj.z.raw = z;
}

function OnLine(l)
{
  last[3] = last[2];
  last[2] = last[1];
  last[1] = last[0];
  last[0] = l;

  var p;
  if ( (p=l.indexOf("#G-")) > -1 )
  	usevalues(dataG, l.substr(p+5).split(","));
  if ( (p=l.indexOf("#M-")) > -1 )
  	usevalues(dataM, l.substr(p+5).split(","));
  if ( (p=l.indexOf("#A-")) > -1 )
	{
  	usevalues(dataA, l.substr(p+5).split(","));

		// workaround for damaged ADXL345
		//x : -337 .. 340
		range = {x:[-337, 340], y:[-520, 170]};

		dataA.x.raw = (dataA.x.raw - range.x[0]) / (range.x[1]-range.x[0]) * 2 * 330 - 330;
		dataA.y.raw = (dataA.y.raw - range.y[0]) / (range.y[1]-range.y[0]) * 2 * 330 - 330;
//		dataA.y.raw += 180;
		dataA.z.raw = Math.sqrt(330*330-(dataA.x.raw*dataA.x.raw + dataA.y.raw*dataA.y.raw));
		if (isNaN(dataA.z.raw))
			dataA.z.raw = 0;
		if (dataM.z.raw < 0)
			dataA.z.raw *= -1;
		
	}

  if ( (p=l.indexOf("YPR")) > -1 )
  	dataC = l.substr(p+5).split(",");
}

  var c = document.getElementById("canvas");
  var ctx = c.getContext('2d');

function clear()
{
				  ctx.fillStyle = "rgba(240, 240, 240, 1)";
				  ctx.fillRect(0, 0, c.width, c.height);
}
function bar(x1, y1, x2, y2, clr)
{
				  ctx.fillStyle = "rgba("+clr+", 1)";
				  ctx.fillRect(x1, y1, x2-x1, y2-y1);
}

function $(id)
{
	return document.getElementById(id);
}
function resetData(obj)
{
  obj.x.minimum = obj.x.maximum = obj.x.raw;
  obj.y.minimum = obj.y.maximum = obj.y.raw;
  obj.z.minimum = obj.z.maximum = obj.z.raw;
}

function Vector_Cross_Product(v1, v2)
{
  var out = [];
  out[0] = (v1[1] * v2[2]) - (v1[2] * v2[1]);
  out[1] = (v1[2] * v2[0]) - (v1[0] * v2[2]);
  out[2] = (v1[0] * v2[1]) - (v1[1] * v2[0]);
	return out;
}

function update()
{
	var minmax = true;

  $("ax").value = dataA.x.raw;
  $("ay").value = dataA.y.raw;
  $("az").value = dataA.z.raw;

  $("gx").value = dataG.x.raw;
  $("gy").value = dataG.y.raw;
  $("gz").value = dataG.z.raw;

  $("mx").value = dataM.x.raw;
  $("my").value = dataM.y.raw;
  $("mz").value = dataM.z.raw;

  if ( minmax )
	{
    $("axmin").value = dataA.x.minimum;
    $("aymin").value = dataA.y.minimum;
    $("azmin").value = dataA.z.minimum;

    $("gxmin").value = dataG.x.minimum;
    $("gymin").value = dataG.y.minimum;
    $("gzmin").value = dataG.z.minimum;

    $("mxmin").value = dataM.x.minimum;
    $("mymin").value = dataM.y.minimum;
    $("mzmin").value = dataM.z.minimum;

    $("axmax").value = dataA.x.maximum;
    $("aymax").value = dataA.y.maximum;
    $("azmax").value = dataA.z.maximum;

    $("gxmax").value = dataG.x.maximum;
    $("gymax").value = dataG.y.maximum;
    $("gzmax").value = dataG.z.maximum;

    $("mxmax").value = dataM.x.maximum;
    $("mymax").value = dataM.y.maximum;
    $("mzmax").value = dataM.z.maximum;
	}

  $("reseta").onclick = function(){ resetData(dataA) };
  $("resetm").onclick = function(){ resetData(dataM) };
  $("resetg").onclick = function(){ resetData(dataG) };


  mg = 0.1; ma = 0.3; mm = 0.3;
  clear();
  bar(100, 200, 110, 200-dataA.x.raw*ma, "255, 128, 128");
  bar(120, 200, 130, 200-dataA.y.raw*ma, "255, 128, 128");
  bar(140, 200, 150, 200-dataA.z.raw*ma, "255, 128, 128");

  bar(200, 200, 210, 200-dataM.x.raw*mm, "128, 255, 128");
  bar(220, 200, 230, 200-dataM.y.raw*mm, "128, 255, 128");
  bar(240, 200, 250, 200-dataM.z.raw*mm, "128, 255, 128");

  bar(300, 200, 310, 200-dataG.x.raw*mg, "128, 128, 255");
  bar(320, 200, 330, 200-dataG.y.raw*mg, "128, 128, 255");
  bar(340, 200, 350, 200-dataG.z.raw*mg, "128, 128, 255");


	var accel = [dataA.x.raw, dataA.y.raw, dataA.z.raw];
	var magnetom = [dataM.x.raw, dataM.y.raw, dataM.z.raw];
	var xAxis = [1, 0, 0];
  pitch = -Math.atan2(accel[0], Math.sqrt(accel[1] * accel[1] + accel[2] * accel[2]));
	
  // GET ROLL
  // Compensate pitch of gravity vector 
  temp1 = Vector_Cross_Product(accel, xAxis);
  temp2 = Vector_Cross_Product(xAxis, temp1);

  roll = Math.atan2(temp2[1], temp2[2]);

  cos_roll = Math.cos(roll);
  sin_roll = Math.sin(roll);
  cos_pitch = Math.cos(pitch);
  sin_pitch = Math.sin(pitch);

  mag_x = magnetom[0] * cos_pitch + magnetom[1] * sin_roll * sin_pitch + magnetom[2] * cos_roll * sin_pitch;
  // Tilt compensated magnetic field Y
  mag_y = magnetom[1] * cos_roll - magnetom[2] * sin_roll;
    // Magnetic Heading
  yaw = Math.atan2(-mag_y, mag_x);

  last[6] = "yaw="+yaw.toFixed(2)+ " pitch="+pitch.toFixed(2)+" roll="+roll.toFixed(2);

ctx.lineWidth = 5;
ctx.strokeColor = "#ff0000";
ctx.beginPath();
ctx.moveTo(350,350);
ctx.lineTo(350+Math.cos(yaw)*50,350+Math.sin(yaw)*50);
ctx.stroke();

ctx.beginPath();
ctx.lineTo(350+Math.cos(yaw+0.1)*40,350+Math.sin(yaw+0.1)*40);
ctx.lineTo(350+Math.cos(yaw)*50,350+Math.sin(yaw)*50);
ctx.lineTo(350+Math.cos(yaw-0.1)*40,350+Math.sin(yaw-0.1)*40);
ctx.stroke();
//currentAngle = roll*180/Math.PI;
draw3d();
  document.getElementById("txt").innerHTML = last.join(""); 

}
    </script>


<!-- 3d render -->
<script src="J3DI.js"> </script>
<script src="J3DIMath.js" type="text/javascript"> </script>


<script id="vshader" type="x-shader/x-vertex">
    uniform mat4 u_modelViewProjMatrix;
    uniform mat4 u_normalMatrix;
    uniform vec3 lightDir;

    attribute vec3 vNormal;
    attribute vec4 vTexCoord;
    attribute vec4 vPosition;

    varying float v_Dot;
    varying vec2 v_texCoord;

    void main()
    {
        gl_Position = u_modelViewProjMatrix * vPosition;
        v_texCoord = vTexCoord.st;
        vec4 transNormal = u_normalMatrix * vec4(vNormal, 1);
        v_Dot = max(dot(transNormal.xyz, lightDir), 0.0);
    }
</script>
<script id="fshader" type="x-shader/x-fragment">
#ifdef GL_ES
    precision mediump float;
#endif
        
    uniform sampler2D sampler2d;

    varying float v_Dot;
    varying vec2 v_texCoord;

    void main()
    {
        vec2 texCoord = vec2(v_texCoord.s, 1.0 - v_texCoord.t);
        vec4 color = texture2D(sampler2d, texCoord);
        color += vec4(0.1, 0.1, 0.1, 1);
        gl_FragColor = vec4(color.xyz * v_Dot, color.a);
    }
</script>

<script language="javascript">
		var gl;
		var currentAngle = 0;

function makeMyBox(ctx)
{
    // vertex coords array
    var texCoords = new Float32Array(
        [  0, 0,   0, 0,   0, 0,   0, 0,    // v0-v1-v2-v3 front
           0, 0,   0, 0,   0, 0,   0, 0,    // v0-v3-v4-v5 right
           //1, 0,   1, 1,   0, 1,   0, 0,    // v0-v5-v6-v1 top
					 0, 1,   0, 0,   1, 0,   1, 1,    // v0-v5-v6-v1 top
           0, 0,   0, 0,   0, 0,   0, 0,    // v1-v6-v7-v2 left
           0.3,0.4,   0.3,0.4,   0.3,0.4, 0.3,0.4,     // v7-v4-v3-v2 bottom
           0, 0,   0, 0,   0, 0,   0, 0 ]   // v4-v7-v6-v5 back
       );


    var vertices = new Float32Array(
        [  1, 1, 1,  -1, 1, 1,  -1,-1, 1,   1,-1, 1,    // v0-v1-v2-v3 front
           1, 1, 1,   1,-1, 1,   1,-1,-1,   1, 1,-1,    // v0-v3-v4-v5 right
           1, 1, 1,   1, 1,-1,  -1, 1,-1,  -1, 1, 1,    // v0-v5-v6-v1 top
          -1, 1, 1,  -1, 1,-1,  -1,-1,-1,  -1,-1, 1,    // v1-v6-v7-v2 left
          -1,-1,-1,   1,-1,-1,   1,-1, 1,  -1,-1, 1,    // v7-v4-v3-v2 bottom
           1,-1,-1,  -1,-1,-1,  -1, 1,-1,   1, 1,-1 ]   // v4-v7-v6-v5 back
    );

		for (i=0; i<vertices.length; i+=3)	
		{
			vertices[i+0] *= 1.3;
			vertices[i+1] *= 0.04;
			vertices[i+2] *= 0.7;
		}

    // normal array
    var normals = new Float32Array(
        [  0, 0, 1,   0, 0, 1,   0, 0, 1,   0, 0, 1,     // v0-v1-v2-v3 front
           1, 0, 0,   1, 0, 0,   1, 0, 0,   1, 0, 0,     // v0-v3-v4-v5 right
           0, 1, 0,   0, 1, 0,   0, 1, 0,   0, 1, 0,     // v0-v5-v6-v1 top
          -1, 0, 0,  -1, 0, 0,  -1, 0, 0,  -1, 0, 0,     // v1-v6-v7-v2 left
           0,-1, 0,   0,-1, 0,   0,-1, 0,   0,-1, 0,     // v7-v4-v3-v2 bottom
           0, 0,-1,   0, 0,-1,   0, 0,-1,   0, 0,-1 ]    // v4-v7-v6-v5 back
       );

    // index array
    var indices = new Uint8Array(
        [  0, 1, 2,   0, 2, 3,    // front
           4, 5, 6,   4, 6, 7,    // right
           8, 9,10,   8,10,11,    // top
          12,13,14,  12,14,15,    // left
          16,17,18,  16,18,19,    // bottom
          20,21,22,  20,22,23 ]   // back
      );

    var retval = { };
    retval.normalObject = ctx.createBuffer();
    ctx.bindBuffer(ctx.ARRAY_BUFFER, retval.normalObject);
    ctx.bufferData(ctx.ARRAY_BUFFER, normals, ctx.STATIC_DRAW);
    retval.texCoordObject = ctx.createBuffer();
    ctx.bindBuffer(ctx.ARRAY_BUFFER, retval.texCoordObject);
    ctx.bufferData(ctx.ARRAY_BUFFER, texCoords, ctx.STATIC_DRAW);
    retval.vertexObject = ctx.createBuffer();
    ctx.bindBuffer(ctx.ARRAY_BUFFER, retval.vertexObject);
    ctx.bufferData(ctx.ARRAY_BUFFER, vertices, ctx.STATIC_DRAW);
    ctx.bindBuffer(ctx.ARRAY_BUFFER, null);
    retval.indexObject = ctx.createBuffer();
    ctx.bindBuffer(ctx.ELEMENT_ARRAY_BUFFER, retval.indexObject);
    ctx.bufferData(ctx.ELEMENT_ARRAY_BUFFER, indices, ctx.STATIC_DRAW);
    ctx.bindBuffer(ctx.ELEMENT_ARRAY_BUFFER, null);
    retval.numIndices = indices.length;
    return retval;
}


    function init3d()
    {
        gl = initWebGL(
            "3d",
	            "vshader", "fshader", 
            [ "vNormal", "vColor", "vPosition"],
            [ 0.4, 0.4, 0.9, 1 ], 10000);

        gl.uniform3f(gl.getUniformLocation(gl.program, "lightDir"), 0, 0, 1);
        gl.uniform1i(gl.getUniformLocation(gl.program, "sampler2d"), 0);
        gl.enable(gl.TEXTURE_2D);

        gl.box = makeMyBox(gl);

        spiritTexture = loadImageTexture(gl, "razor.jpg");

        gl.mvMatrix = new J3DIMatrix4();
        gl.u_normalMatrixLoc = gl.getUniformLocation(gl.program, "u_normalMatrix");
        gl.normalMatrix = new J3DIMatrix4();
        gl.u_modelViewProjMatrixLoc = gl.getUniformLocation(gl.program, "u_modelViewProjMatrix");
        gl.mvpMatrix = new J3DIMatrix4();

        gl.enableVertexAttribArray(0);
        gl.enableVertexAttribArray(1);
        gl.enableVertexAttribArray(2);

        gl.bindBuffer(gl.ARRAY_BUFFER, gl.box.vertexObject);
        gl.vertexAttribPointer(2, 3, gl.FLOAT, false, 0, 0);
        gl.bindBuffer(gl.ARRAY_BUFFER, gl.box.normalObject);
        gl.vertexAttribPointer(0, 3, gl.FLOAT, false, 0, 0);
        gl.bindBuffer(gl.ARRAY_BUFFER, gl.box.texCoordObject);
        gl.vertexAttribPointer(1, 2, gl.FLOAT, false, 0, 0);

        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, gl.box.indexObject);

				reshape(gl);
        return gl;
    }

    width = -1;
    height = -1;

    function reshape(gl)
    {
        var canvas = document.getElementById('3d');
//        if (canvas.width == width && canvas.height == height)
//            return;

        width = canvas.width;
        height = canvas.height;

        // Set the viewport and projection matrix for the scene
        gl.viewport(0, 0, width, height);
        gl.perspectiveMatrix = new J3DIMatrix4();
        gl.perspectiveMatrix.perspective(30, width/height, 1, 10000);
        gl.perspectiveMatrix.lookat(0, 0, 7, 0, 0, 0, 0, 1, 0);
    }

    function drawPicture(gl)
    {
        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

        gl.mvMatrix.makeIdentity();
//				gl.mvMatrix.translate(0, 0, -10);
//        gl.mvMatrix.rotate(20, 1,0,0);
//				var sc = 2;
//        gl.mvMatrix.scale(1*sc, 0.1*sc, 1*sc);
//        gl.mvMatrix.rotate(currentAngle, 0,1,0);
        gl.mvMatrix.rotate(yaw*180/Math.PI, 0,-1,0);
        gl.mvMatrix.rotate(pitch*180/Math.PI, 0,0,1);
        gl.mvMatrix.rotate(roll*180/Math.PI, 1,0,0);

//  rotateX(-radians(pitch));
//  rotateY(-radians(yaw - yawOffset));
//  rotateZ(radians(roll)); 

//        gl.mvMatrix.rotate(yaw*180/Math.PI, 0,1,0);

        gl.normalMatrix.load(gl.mvMatrix);
        gl.normalMatrix.invert();
        gl.normalMatrix.transpose();
        gl.normalMatrix.setUniform(gl, gl.u_normalMatrixLoc, false);

        gl.mvpMatrix.load(gl.perspectiveMatrix);
        gl.mvpMatrix.multiply(gl.mvMatrix);
        gl.mvpMatrix.setUniform(gl, gl.u_modelViewProjMatrixLoc, false);

        gl.bindTexture(gl.TEXTURE_2D, spiritTexture);
        gl.drawElements(gl.TRIANGLES, gl.box.numIndices, gl.UNSIGNED_BYTE, 0);
        gl.flush();
    }

		function draw3d()
		{
			drawPicture(gl);
		}
</script>

</body>
</html>
